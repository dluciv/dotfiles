#!/bin/bash

set -e

input_file=$1
temp_root="${TMPDIR:-${TEMP:-${TMP:-/tmp}}}"

touch "${temp_root}/_sgf.log"
chmod go-rwx "${temp_root}/_sgf.log"

if command -v ssconvert 1>/dev/null 2>&1; then
  ssconvert --export-type='Gnumeric_html:xhtml_range' "$input_file" 'fd://1' 2>>"${temp_root}/_sgf.log" | pandoc -t markdown -f html 2>>"${temp_root}/_sgf.log"
elif command -v soffice 1>/dev/null 2>&1; then
  bni_file=$(basename "$input_file")
  tmp_html="${bni_file%.*}.html"
  tmp_txt="${bni_file%.*}.txt"

  # echo "--- ${TMPDIR} ---"


  echo "$$ $(date)" >>"${temp_root}/_sgf.log"
  echo "$$ $(pwd)"  >>"${temp_root}/_sgf.log"
  echo "$$ $*" >>"${temp_root}/_sgf.log"

  td=$(mktemp -d)
  cp "$input_file" "$td"
  pushd $td >>"${temp_root}/_sgf.log"

  # The most idiotic way I guess, but for me it was the only one working
  soffice --headless --convert-to html "$bni_file" 2>>"${temp_root}/_sgf.log" 1>&2
  pandoc -t markdown -f html "$tmp_html" 2>>"${temp_root}/_sgf.log"

  # set +e
  # rm $tmp_pdf $tmp_txt

  popd
  rm -rf "$td"
else
  echo "$$ no ssconvert (gnumeric) or soffice installed" >>"${temp_root}/_sgf.log"
fi

echo '$$ -------------------------' >>/tmp/_sgf.log
