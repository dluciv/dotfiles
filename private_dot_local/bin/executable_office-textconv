#!/bin/bash

inpfile="$1"
inpbase=$(basename "$inpfile")
inpsufx=${inpbase##*.}

installed () {
  command -v "$1" &>/dev/null;
}

cat_pdf () {
  pdftotext -layout "$1" -enc UTF-8 - 2>/dev/null
}

textconv_pdf () {
  cat_pdf "$inpfile"
}

textconv_document () {
  case "$inpsufx" in
    odt|docx)
      if installed pandoc; then
        pandoc -t plain -f docx "$inpfile"
        return
      fi
    ;;
    rtf)
      if installed pandoc; then
        pandoc -t plain -f rtf "$inpfile"
        return
      elif installed unrtf; then
        unrtf --text "$inpfile"
        return
      fi
    ;;
    doc)
      if installed antiword; then
        catdoc "$inpfile"
        return
      elif installed catdoc; then
        catdoc <"$inpfile"
        return
      fi
    ;;
  esac

  # Use soffice as universal fallback tool
  if installed soffice; then
    tmpdir=$(mktemp -d)
    ln -s "$(realpath "$inpfile")" "${tmpdir}/convert.${inpsufx}"
    pushd "$tmpdir" &>/dev/null || exit 1

    SAL_DISABLE_OPENCL=1 SAL_DISABLEGL=1 soffice --headless --cat "convert.${inpsufx}" 2>/dev/null

    popd &>/dev/null || exit 1
    rm -rf "$tmpdir"
  else
    echo "No pandoc or antiword or catdoc or unrtf or soffice installed..." >&2
    exit 1
  fi
}

textconv_spreadsheet () {
  tmpdir=$(mktemp -d)
  ln -s "$(realpath "$inpfile")" "${tmpdir}/convert.${inpsufx}"
  pushd "$tmpdir" &>/dev/null || exit 1

  if installed soffice; then
    SAL_DISABLE_OPENCL=1 SAL_DISABLEGL=1 soffice --headless --convert-to html "convert.${inpsufx}" &>/dev/null
  elif installed ssconvert; then
    ssconvert "convert.${inpsufx}" "convert.html" &>/dev/null
  else
    echo "No GNUmeric ssconvert or soffice installed..." >&2
    exit 1
  fi
  popd &>/dev/null || exit 1

  if installed pandoc; then
    pandoc -t plain -f html "${tmpdir}/convert.html"
  elif installed links; then
    links -dump "${tmpdir}/convert.html" 2>/dev/null
  elif installed w3m; then
    w3m -dump "${tmpdir}/convert.html" 2>/dev/null
  elif installed lynx; then
    lynx -dump -force_html "${tmpdir}/convert.html" 2>/dev/null
  else
    echo "No pandoc or links or w3m or lynx installed..." >&2
    exit 1
  fi

  rm -rf "$tmpdir"
}

textconv_slides () {
  if installed soffice && installed pdftotext; then

    tmpdir=$(mktemp -d)
    ln -s "$(realpath "$inpfile")" "${tmpdir}/convert.${inpsufx}"

    pushd "$tmpdir" &>/dev/null || exit 1

    SAL_DISABLE_OPENCL=1 SAL_DISABLEGL=1 soffice --headless --convert-to pdf "convert.${inpsufx}" &>/dev/null
    cat_pdf "convert.pdf"

    popd &>/dev/null || exit 1
    rm -rf "$tmpdir"
  else
    echo "No soffice & pdftotext installed..." >&2
    exit 1
  fi
}

prepare_output () {
  md5sum -b "$inpfile" # To better visualize file change without textual representation change
  echo '========================================'

  case "$inpsufx" in
    pdf)
      textconv_pdf
    ;;
    odt|docx|doc|rtf)
      textconv_document
    ;;
    ods|xlsx|xls)
      textconv_spreadsheet
    ;;
    odp|pptx|ppt)
      textconv_slides
    ;;
    *)
      echo "How to convert '$inpfile'?.." >&2
    ;;
  esac
}

if [[ -t 1 ]]; then
  prepare_output | "${PAGER:-less}"
else
  prepare_output
fi
