#!/bin/zsh

. ~/.config/hiddify-cli/config.run

runhcli () {
  pushd $(dirname $(readlink $HCLIBIN)) &>/dev/null
  ionice -c 3 -- nice $HCLIBIN run \
    --log-level warn \
    --web-port 16756 \
    --web-secret $WEBSECRET \
    --hiddify ~/.config/hiddify-cli/config.json \
    --config $SUBURL
  popd &>/dev/null
}

if command -v $HCLIBIN 1>/dev/null; then

  case $1 in
    start)
      runhcli &>/dev/null &!
      echo $! >"${XDG_RUNTIME_DIR}/hcli.pid"
    ;;

    stop)
      pid=$(cat "${XDG_RUNTIME_DIR}/hcli.pid") && kill $pid || killall $HCLIBIN
      rm "${XDG_RUNTIME_DIR}/hcli.pid"
    ;;

    run)
      runhcli
    ;;

    *)
      pid=$(cat "${XDG_RUNTIME_DIR}/hcli.pid")
      if [[ $? == 0 ]] && kill -0 $pid; then
        echo "Running, pif $pid"
        netstat -tpln | grep HiddifyCli
      else
        echo "Likely not runnging"
      fi
    ;;
  esac

else

  >&2 echo WTF

fi
